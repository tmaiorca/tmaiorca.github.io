---
title: Cracking WPA2 Preshared Keys (PSK)
date: 2023-04-08 17:00
categories: [Wireless Penetration Testing]
tags: [wireless,wpa2,offensive] #TAG names should always be lowercase
---

## A little bit about wireless security...
WEP and WPA cracking were the first things I broke into in my homelab. Why? Mostly because those were the things I wanted to "hack" as a young, ignorant teen. They also were the easiest to follow because while there is a methadology to wireless security, as long as I had a compatible wireless nic that supported packet monitoring and injection, I was set. 

## Disclaimer
The information provided is intended solely for educational purposes. The use of any information or any activities undertaken by readers based on the information provided on this website are at their own risk. The tools and information discussed when used improperly or without proper authorization, may violate laws and regulations, and may result in civil and/or criminal liability. The content of this website does not constitute legal, professional or technical advice, and should not be relied upon as such. The use of any information or recommendations provided on this website is solely at the user's own risk.


## Wait, I thought WPA2 can't be cracked?
Well, it *can* be, it's just that cracking WPA2 relies on using a dictionary, either pre-compiled or one created using a custom wordlist, possibly with permutations to be more targeted.

For the sake of this proof of concept, I'll be demonstrating using a wordlist file that contains the correct pre-shared key, amonst some incorrect ones. In the real world, it is very unlikely that you will be able to pull off a WPA2 dictionary attack without performing some type of reconnaissance beforehand.  


## Mitigations!
<li><i>Strong and long</i> passwords (preferably ones generated by a password manager)</li>
<li>Use of a passphrase, rather than a password</li>
<li>Use of X.509 certificates (WPA2-Enterprise)</li>
<br>
What's important is to not use dictionary words. Consider using a passphrase, or, rely on a long password, preferably 12 characters in length. To get a sense of how strong a password may be, also consider using a password strength calculator, such as the one provided by <a href="https://bitwarden.com/password-strength/" target="_blank" rel="noopener noreferrer">Bitwarden</a>.


## Overview of steps
<b>1.Prerequisites</b> - checking and killing any processing that interface with our wireless nic's monitor mode<br>
<b>2.Place</b> - placing your wireless nic in monitor mode<br>
<b>3.Discover</b> - discover information about the discovered networks<br>
<b>4.Select</b> - select and target a network to capture data from<br>
<b>5.Perform</b> - perform deauthentication attack in order to capture a handshake<br>
<b>6.Capture</b> - capturing the WPA handshake<br>
<b>7.Attempt</b> - attempt to crack the captured handshake using an offline cracking tool<br>

Easy enough, right? Let's get started!


## Setting up your environment
Below are some of the specifics for my lab. The MAC of the attack machine, client device, and access point, along with the SSID, will be different in your environment. Also, for the sake of lab purposes, I'm running the attacker machine inside a virtual machine on my lab host. In the real world, you may have a dedicated device running the packet capturing and cracking tools. 
<li><i>Wireless Network Adapter</i>: ALFA AC1200 with a RTL8812AU chipset (<a href="https://www.amazon.com/gp/product/B00VEEBOPG/ref=ppx_yo_dt_b_asin_title_o00_s00?ie=UTF8&psc=1" target="_blank" rel="noopener norefferrer">$65 on amazon</a> as of the writing of this post)<br></li>
<li><i>Wireless SSID</i>: Wu Tang Lang</li>
<li><i>Wireless SSID PSK</i>: cr4ckTh1s!</li>
<li><i>Attacker Machine</i>: Kali Linux (running as a vm)</li>
<li><i>Attacker Machine MAC</i>: 5a:ee:25:a8:d3:cd</li>
<li><i>Attacker Machine Wireless Interface</i>: wlan0</li>
<li><i>Virtualization Platform</i>: VMware Player Workstation</li>
<li><i>Victim Machine MAC Address</i>: f8:1a:2b:53:fb:e4</li>
<li><i>BSSID (MAC address of access point)</i>: e2:63:da:34:16:5b</li>
<li><i>Access Point Channel</i>: 11</li>

<br>

First, let's make sure that the base OS running the attacker machine as a VM has the Alfa wireless adapter detected and installed with the appropriate <a href="https://github.com/aircrack-ng/rtl8812au" target="_blank" rel="noopener norefferrer">drivers</a>. 
![img-description](/assets/wpa2_poc_devicemanager.png)

Then, attach the wireless adapter to the VM acting as the attacker machine. 
![img-description](/assets/wpa2_poc_nicattach.png)

Finally, run an ```ifconfig/iwconfig``` and verify that the wireless adapter was attached successfully and being detected by the VM. In this case, Kali assigned the adapter to the ```wlan0``` interface.
![img-description](/assets/wpa2_poc_wlan0.png)


## A Quick Mention About Aircrack-ng
Now's a good time to talk about the suite of tools we are going to leverage in order to perform this PoC - <b><i><a href="https://www.aircrack-ng.org/doku.php?id=Main" target="_blank" rel="noopener norefferrer">aircrack-ng</a></i></b>. Aircrack are a suite of tools to assess the wireless security of networks and access points. 
![img-description](/assets/wpa2_poc_aircrackng.png)

<br>
We're going to be using four different aircrack tools for this demonstration:<br>
<b><i>Airmon-ng</i></b><br>
---used to enable monitor mode on wireless interfaces<br>
---used to kill network managers, or go back from monitor mode to managed mode<br>

<b><i>Airodump-ng</i></b><br>
---used for packet capture of raw 802.11 frames<br>
---used for collecting WEP IVs and WPA handshakes (to be subsequently used with aircrack-ng)<br>

<b><i>Airreplay-ng</i></b><br>
---used to generate traffic to be used by aircrack-ng for cracking WPA-PSK and WEP keys<br>
---used to deauthenticate clients to capture WPA handshake data and hand-crafted ARP request reinjection<br>

<b><i>Aircrack-ng</i></b><br>
---used to crack WPA/WPA2 and WEP keys<br>
---can only crack pre-shared keys<br>


## Step 1: Prerequisites
The first step is to ensure that we terminate any other processes that would interfere with changing our network adapter's mode, in this case from 'managed' to '<b>monitor</b>', using <b>airmon-ng</b>.

On the Attacker machine, type the following in a console shell: ```airmon-ng check kill```
![img-description](/assets/wpa2_poc_aircrack-prereq.png)

## Step 2: Place Network Adapter into Monitor Mode
Second, we must place our network adapter into <b>'Monitor'</b> mode (previously, 'Managed'), so that it can monitor all traffic on the given wireless channel.
![img-description](/assets/wpa2_poc_aircrack-start.png)

We can confirm this was successful by issuing: ```iwconfig```
![img-description](/assets/wpa2_poc_aircrack-iwconfig.png)

## Step 3: Discovering Networks
Now that the network adapter is in <b>Monitor</b> mode, it can begin to discover and analyze different networks in range.

To do this, we are going to use <b>airodump-ng</b>: ```airodump-ng wlan0``` where ```wlan0``` is the value assigned to the mounted wireless network adapter. 
![img-description](/assets/wpa2_poc_aircrack-discover.png)

Some things to note about the information returned about the various networks:
* ESSID: wireless network name
* BSSID: MAC address of the ESSID's access point
* PWE (Power): lower the number, the closer you are to the Access Point
* Channels: 1,6,11 have no overlap
* ENC: authentication type

In this case, the network we are targeting is our lab:  ```Wu Tang LAN```
* ESSID: Wu Tang LAN
* BSSID: E2:63:DA:34:16:5B
* ENC: WPA2 CCMP
* AUTH: PSK (Pre-shared Key)
* Channel: 11

With this information, we can now monitor authentication packets from this network to try and intercept a handshake that can be later taken offline and cracked. But first, we must capture and perform a deauthentication attack in order to obtain the handshake.

## Step 4: Selecting the Target Network
We need to format the command that will capture the WPA handshake from a client attempting authentication to our desired access point during the next step. 

Syntax: ```airodump-ng -c <channel> --bssid <mac of bssid> -w <output file path> ```

Using the information captured from Step 3, this gives us:<br>
```airodump-ng -c 11 --bssid E2:63:DA:34:16:5B -w wpa2_cracking_poc```

Executing this command will create a running capture of any 802.11 frames for WPA handshakes. This will be particularly useful when we deauthenticate a client from this network in the next step.
![img-description](/assets/wpa2_poc_airodump-capture.png)

What we're looking for is a client that has is communicating with the access point that can be used as the subject of a deauthentication attack in Step 5. By doing so, the client will reauthenticate using a WPA handshake, which can later be taken offline to be cracked.
![img-description](/assets/wpa2_poc_airodump-capture2.png)

Take note of the client's MAC address, as this will be used in the deauth attack. For the purpose of this PoC, the client device is a mobile phone. <b>Keep the console open and let the output continually generate on-screen.</b>

## Step 5: Performing the Deauthentication Attack
Now that we know the MAC address of a client connected to an access point of our desired network, we can target it for a deauthentication attack. 

We are going to used the ```aireplay-ng``` tool of the aircrack-ng suite. The syntax we are going to use is as follows:<br>
```aireplay-ng -<mode> <# of times to perform> -a <MAC of access point> -c <MAC of station/client being attacked> <wireless_interface>```

Using the information collected from Steps 3 and 4:
 * --deauth = mode of the aireplay-ng tool
 * -a = E2:63:DA:34:16:5B (ESSID of 'Wu Tang LAN')
 * -c = F8:1A:2B:53:FB:E4 (MAC of the mobile device)
 * wlan0 = interface of the mounted wireless adapter
<br>

Because our packet capture from Step 4 is continually running, we need to issue the following command in a <i>separate console shell</i>:
```aireplay-ng --deauth 5 -a E2:63:DA:34:16:5B -c F8:1A:2B:53:FB:E4 wlan0```
![img-description](/assets/wpa2_poc_aireplay.png)

After issuing, the mobile device in our lab is disconnected from the 'Wu Tang LAN' network, and automatically attempts to reconnect. 
![img-description](/assets/wpa2_poc_aireplay-deauth.png)

## Step 6: Capturing the Handshake
While reconnecting, the WPA handshake containing the PSK (password) of the SSID is captured by the ```airodump-ng``` tool running from Step 4.
![img-description](/assets/wpa2_poc_aireplay-handshake.png)
<i>Note: sometimes, it is required to issue the deauth numerous times in order to get the WPA handshake</i>

The captured WPA handshake is saved to the local directory. This handshake will contain the valid pre-shared key used to authenticate into the 'Wu Tang LAN' network!
![img-description](/assets/wpa2_poc_handshake-output.png)

## Step 7: Attempt to Crack the Handshake
Finally, now that we have the WPA handshake, we can use a cracking tool, like ```aircrack-ng``` or ```hashcat```, to try and brute-force the correct password. 

For this PoC, a wordlist containing 10 passwords is used, however only one which is valid. In this real world, you would need to do a dictionary attack and/or use a custom wordlist with permutations tailored for the target, such as street address, phone number, pet name, sports team, etc. 

The syntax of the aircrack-ng command will be: ```aircrack-ng -w wifi_wordlist.txt -b <BSSID of AP> <capture file>```

Which, finally, gives us: ```aircrack-ng -w psk_wordlist.txt -b E2:63:DA:34:16:5B wpa2_cracking_poc-01.cap```
![img-description](/assets/wpa2_poc_aircrack-psk.png)

And that's it! The PSk was found, which in  this case, is <b>cr4ckTh1s!</b>
